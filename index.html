<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unsubscribe</title>
    <style>
        /* Modern UI Styles */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
        h1 { font-size: 22px; color: #333; margin-bottom: 10px; }
        p { color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 25px; }
        .email-badge { background: #eef2f5; padding: 5px 10px; border-radius: 4px; font-weight: 600; color: #333; display: inline-block; margin-bottom: 20px; font-size: 13px; word-break: break-all;}
        .btn { background: #000; color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin-top: 15px; font-size: 13px; min-height: 18px; }
        .error { color: #d93025; }
        .success { color: #188038; }
    </style>

    <script type="text/javascript">
        // We manually create the $WZRK_WR object so you can use it on Vercel
        window.$WZRK_WR = {
            // The method you requested
            getEmail: function(reEncode) {
                var urlParams = new URLSearchParams(window.location.search);
                var encodedEmail = urlParams.get('e');
                
                if (!encodedEmail) return null;

                try {
                    // Standard Base64 Decode
                    // If reEncode is true, some legacy setups decode twice, but usually once is enough for standard campaigns
                    return decodeURIComponent(escape(window.atob(encodedEmail)));
                } catch (e) {
                    console.error("WZRK: Could not decode email", e);
                    return null;
                }
            }
        };
    </script>

    <script type="text/javascript">
        var clevertap = {event:[], profile:[], account:[], onUserLogin:[], notifications:[], region:'eu1'};
        // YOUR ACCOUNT ID
        clevertap.account.push({"id": "R57-875-KK7Z"}); 
        
        (function () {
            var wzrk = document.createElement('script');
            wzrk.type = 'text/javascript';
            wzrk.async = true;
            wzrk.src = 'https://d2r1yp2w7bby2u.cloudfront.net/js/clevertap.min.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(wzrk, s);
        })();
    </script>
</head>
<body>

    <div class="card">
        <h1>Unsubscribe</h1>
        
        <div id="email-container" style="display:none;">
            <div class="email-badge" id="user-email-display">Loading...</div>
        </div>

        <p>Manage your email preferences below.</p>

        <button id="unsubBtn" class="btn" onclick="processUnsubscribe()">
            Unsubscribe Me
        </button>

        <div id="status"></div>
    </div>

    <script>
        // --- 3. EXECUTION LOGIC ---
        
        // A. USE THE WZRK METHOD TO GET EMAIL
        // We pass 'false' because standard CT links are single-encoded
        var targetEmail = window.$WZRK_WR.getEmail(false);

        // B. SETUP UI
        var btn = document.getElementById('unsubBtn');
        var statusDiv = document.getElementById('status');
        var emailDisplay = document.getElementById('user-email-display');

        if (targetEmail) {
            emailDisplay.innerText = targetEmail;
            document.getElementById('email-container').style.display = 'block';
            console.log("WZRK: Email extracted successfully:", targetEmail);
        } else {
            // Fallback: Check if they used the plain 'email' param or if decoding failed
            console.warn("WZRK: No email found in 'e' parameter.");
            var urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('email')) {
                targetEmail = urlParams.get('email'); // Fallback to plain text
                emailDisplay.innerText = targetEmail;
                document.getElementById('email-container').style.display = 'block';
            } else {
                statusDiv.innerText = "Error: Invalid link. Please open from email.";
                statusDiv.className = "error";
                btn.disabled = true;
            }
        }

        // C. UNSUBSCRIBE ACTION
        function processUnsubscribe() {
            if (!targetEmail) return;

            btn.disabled = true;
            btn.innerText = "Processing...";

            // 1. PUSH TO CLEVERTAP (The "All Objects" approach)
            clevertap.onUserLogin.push({
                "Site": {
                    "Identity": targetEmail,    // Primary identifier
                    "Email": targetEmail,       // Update Email field
                    
                    // The Preferences
                    "MSG-email": false,         // Global Unsubscribe
                    "premium user sub": false   // Custom flag
                }
            });

            // 2. LOG EVENT
            clevertap.event.push("Unsubscribe Action", {
                "Method": "WZRK_WR Custom Page",
                "Status": "Success"
            });

            // 3. UI FEEDBACK
            setTimeout(function() {
                btn.innerText = "Unsubscribed";
                statusDiv.innerText = "Success! Preference updated.";
                statusDiv.className = "success";
            }, 1000);
        }
    </script>

</body>
</html>
