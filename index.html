<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Preferences</title>
    
    <style>
        body { font-family: sans-serif; padding: 40px; display: flex; justify-content: center; background: #f4f6f8; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; width: 100%; text-align: center; }
        h2 { margin-top: 0; color: #333; }
        p { color: #666; }
        
        .email-display { 
            background: #eef; color: #333; padding: 8px 12px; 
            border-radius: 4px; font-weight: bold; margin: 10px 0 20px 0; 
            display: inline-block; word-break: break-all;
        }

        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin: 5px; width: 45%; color: white;}
        .btn-active { background-color: #28a745; }
        .btn-inactive { background-color: #dc3545; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #error-message { color: red; display: none; margin-top: 10px; }
        #success-message { color: green; display: none; margin-top: 10px; font-weight: bold; }
    </style>

    <script type="text/javascript">
         var clevertap = {event:[], profile:[], region:'in1', account:[], onUserLogin:[], notifications:[]};
         
         // !!! REPLACE WITH YOUR ACCOUNT ID !!!
         clevertap.account.push({"id": "R57-875-KK7Z"}); 
         
         (function () {
             var wzrk = document.createElement('script');
             wzrk.type = 'text/javascript';
             wzrk.async = true;
             wzrk.src = 'https://d2r1yp2w7bby2u.cloudfront.net/js/clevertap.min.js';		 
             var s = document.getElementsByTagName('script')[0];
             s.parentNode.insertBefore(wzrk, s);
         })();
    </script>

    <script>
        if (typeof window.$WZRK_WR === 'undefined') {
            window.$WZRK_WR = {
                getEmail: function() {
                    var params = new URLSearchParams(window.location.search);
                    if (params.get('e')) {
                        // Decode the 'e' parameter
                        var decoded = atob(params.get('e'));
                        // Call the callback function immediately
                        if (typeof wzrk_email_fetched === 'function') {
                            wzrk_email_fetched(decoded);
                        }
                    } else if (params.get('email')) {
                        // Fallback for plain text
                        if (typeof wzrk_email_fetched === 'function') {
                            wzrk_email_fetched(params.get('email'));
                        }
                    } else {
                        console.warn("No email found in URL");
                    }
                }
            };
        }
    </script>
</head>
<body>

    <div class="card">
        <h2>User Preferences</h2>
        <p>Managing settings for:</p>
        
        <div id="user-email" class="email-display">Detecting...</div>

        <div id="controls" style="display:none;">
            <p>Update your status:</p>
            <button class="btn btn-active" onclick="updateUserProp(true)">Set Active</button>
            <button class="btn btn-inactive" onclick="updateUserProp(false)">Set Inactive</button>
        </div>

        <div id="success-message">Settings Updated!</div>
        <div id="error-message">Could not detect user email. Please use the link from your inbox.</div>
    </div>

    <script>
        var currentEmail = null;

        // A. ONLOAD: Grab the email using the method you requested
        window.onload = function() {
            // We pass 'false' for re-encode, and removed 'withGroups' since you don't want them
            if (window.$WZRK_WR && window.$WZRK_WR.getEmail) {
                $WZRK_WR.getEmail(false); 
            }
        };

        // B. CALLBACK: This runs automatically when email is fetched
        function wzrk_email_fetched(emailStr) {
            console.log("Email grabbed:", emailStr);
            
            if (emailStr) {
                currentEmail = emailStr;
                document.getElementById("user-email").innerText = emailStr;
                document.getElementById("controls").style.display = "block";
            } else {
                document.getElementById("error-message").style.display = "block";
                document.getElementById("user-email").innerText = "Unknown";
            }
        }

        // C. UPDATE ACTION: Strictly updates user property, no events
        function updateUserProp(value) {
            if (!currentEmail) return;

            // Pushing to Profile via onUserLogin (safest for custom pages)
            clevertap.onUserLogin.push({
                "Site": {
                    "Identity": currentEmail,   // Identify User
                    "premium user sub": value   // Update ONLY this property
                }
            });

            // UI Feedback
            document.getElementById("success-message").style.display = "block";
            
            // Optional: Hide success msg after 2 seconds
            setTimeout(function() {
                document.getElementById("success-message").style.display = "none";
            }, 3000);
        }
    </script>

</body>
</html>
